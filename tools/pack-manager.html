<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesdro! ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* ãƒªã‚»ãƒƒãƒˆï¼‹åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2rem;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
    }

    h2 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    h3 {
      color: #555;
      margin: 1.5rem 0 0.5rem 0;
      font-size: 1.1rem;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      font-size: 1rem;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    input[type="file"] {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      width: 100%;
    }

    /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
    }

    .preview-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .preview-item.selected {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnail-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #667eea;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 1;
    }

    .info {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }

    /* ãƒœã‚¿ãƒ³ */
    .primary-btn {
      background: #667eea;
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    .primary-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .primary-btn:active {
      transform: translateY(0);
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    button:hover {
      background: #218838;
    }

    button:active {
      transform: scale(0.98);
    }

    /* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
    #outputArea {
      margin-top: 2rem;
    }

    #outputArea textarea {
      font-family: 'Courier New', Consolas, Monaco, monospace;
      font-size: 0.875rem;
      min-height: 200px;
      background: #2d2d2d;
      color: #f8f8f2;
      border: none;
      padding: 1rem;
    }

    /* ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .guide {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
    }

    .guide ol {
      padding-left: 1.5rem;
    }

    .guide li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    .guide code {
      background: #d0d0d0;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }

    /* èª­ã¿è¾¼ã¿ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é¸æŠæ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .selection-counter {
      text-align: center;
      margin: 1rem 0;
    }

    .count-text {
      display: inline-block;
      font-size: 1.25rem;
      font-weight: bold;
      color: #667eea;
      padding: 0.5rem 1rem;
      background: white;
      border-radius: 8px;
      border: 2px solid #667eea;
    }

    .count-text.complete {
      color: #28a745;
      border-color: #28a745;
      background: #e8f5e9;
    }

    .preview-grid-selectable .preview-item {
      position: relative;
    }

    .preview-checkbox {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      width: 24px;
      height: 24px;
      z-index: 2;
      cursor: pointer;
      accent-color: #667eea;
    }

    .preview-item.preview-selected {
      border-color: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }

    .preview-badge {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      background: #28a745;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 1;
    }

    .photo-upload .preview-grid .preview-item {
      cursor: pointer;
    }

    .preview-selection .preview-grid .preview-item {
      cursor: default;
    }

    /* Section 2.6: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
    .preview-dropzone {
      border: 3px dashed #667eea;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      margin: 1rem 0;
    }

    .preview-dropzone:hover {
      border-color: #5568d3;
      border-style: solid;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transform: scale(1.02);
    }

    .preview-dropzone.drag-over {
      border-color: #28a745;
      border-style: solid;
      background: #e8f5e9;
      box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
      transform: scale(1.05);
    }

    .preview-dropzone-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .preview-dropzone-text {
      font-size: 1.1rem;
      color: #667eea;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .preview-dropzone-hint {
      font-size: 0.9rem;
      color: #999;
    }

    .preview-only-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .preview-only-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 3px solid #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
      transition: all 0.3s;
    }

    .preview-only-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);
    }

    .preview-only-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-only-badge {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: #28a745;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: bold;
      z-index: 1;
    }

    .remove-preview-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #dc3545;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: all 0.2s;
      margin: 0;
      padding: 0;
    }

    .remove-preview-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .preview-only-count {
      display: inline-block;
      font-size: 1.25rem;
      font-weight: bold;
      color: #667eea;
      padding: 0.5rem 1rem;
      background: white;
      border-radius: 8px;
      border: 2px solid #667eea;
      margin: 1rem 0;
    }

    .preview-only-count.complete {
      color: #28a745;
      border-color: #28a745;
      background: #e8f5e9;
    }

    .preview-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .clear-preview-btn {
      flex: 1;
      background: #dc3545;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .clear-preview-btn:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .download-zip-btn {
      flex: 1;
      background: #667eea;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .download-zip-btn:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .download-zip-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .zip-guide {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 4px;
    }

    .zip-guide h4 {
      color: #856404;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .zip-guide ol {
      margin-left: 1.5rem;
      color: #856404;
    }

    .zip-guide li {
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .zip-guide code {
      background: #fff;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: monospace;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ Gesdro! ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‘ãƒƒã‚¯æƒ…å ±å…¥åŠ› -->
    <section class="pack-info">
      <h2>1. ãƒ‘ãƒƒã‚¯æƒ…å ±</h2>
      <form id="packForm">
        <input type="text" id="packId" placeholder="ãƒ‘ãƒƒã‚¯IDï¼ˆä¾‹: pack-portrait-proï¼‰" required>

        <input type="text" id="nameJa" placeholder="ãƒ‘ãƒƒã‚¯åï¼ˆæ—¥æœ¬èªï¼‰" required>
        <input type="text" id="nameEn" placeholder="Pack Name (English)" required>

        <textarea id="descJa" placeholder="èª¬æ˜æ–‡ï¼ˆæ—¥æœ¬èªï¼‰" required></textarea>
        <textarea id="descEn" placeholder="Description (English)" required></textarea>

        <select id="category" required>
          <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</option>
          <option value="portrait">ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ</option>
          <option value="pose">ãƒãƒ¼ã‚º</option>
          <option value="hand">æ‰‹</option>
          <option value="animal">å‹•ç‰©</option>
          <option value="landscape">é¢¨æ™¯</option>
        </select>

        <label>
          <input type="checkbox" id="isFree">
          ç„¡æ–™ãƒ‘ãƒƒã‚¯
        </label>

        <input type="number" id="price" placeholder="ä¾¡æ ¼ï¼ˆå††ï¼‰" min="0" value="0">

        <input type="text" id="stripeProductId" placeholder="Stripe Product IDï¼ˆå¾Œã§è¨­å®šå¯ï¼‰">
        <input type="text" id="stripePriceId" placeholder="Stripe Price IDï¼ˆå¾Œã§è¨­å®šå¯ï¼‰">
      </form>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <section class="photo-upload">
      <h2>2. å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <input type="file" id="photoInput" accept="image/*" multiple>
      <div id="photoPreview" class="preview-grid"></div>
      <p class="info">â€» ã‚µãƒ ãƒã‚¤ãƒ«ã«ã—ãŸã„å†™çœŸã‚’1æšã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ï¼ˆé’æ ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
      <p class="info" style="margin-top: 0.5rem; color: #667eea;">
        ğŸ’¡ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯ã€<strong>ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ã§å°‚ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰</strong>ã¾ãŸã¯<strong>ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠ</strong>ã§ãã¾ã™
      </p>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒé¸æŠ -->
    <section class="preview-selection">
      <h2>2.5 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒé¸æŠ</h2>
      <p class="info">
        ãƒ‘ãƒƒã‚¯è³¼å…¥ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’<strong>æ­£ç¢ºã«9æš</strong>é¸æŠã—ã¦ãã ã•ã„ã€‚
        <br>â€» ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã¨é‡è¤‡ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚æœ€ä½9æšã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
      </p>

      <div class="selection-counter">
        <span id="previewCount" class="count-text">0/9 é¸æŠæ¸ˆã¿</span>
      </div>

      <div id="previewSelectionGrid" class="preview-grid preview-grid-selectable"></div>

      <p class="info" style="margin-top: 1rem; color: #d32f2f;" id="previewError" hidden>
        âš ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’æ­£ç¢ºã«9æšé¸æŠã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨: <span id="errorCount">0</span>æšï¼‰
      </p>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒå°‚ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <section class="preview-only-section">
      <h2>2.6 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒå°‚ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰</h2>
      <p class="info">
        <strong>ğŸ’¡ æ–°æ©Ÿèƒ½:</strong> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ9æšã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãã¾ã™ã€‚<br>
        ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚µãƒ ãƒã‚¤ãƒ«ã‚‚è‡ªå‹•çš„ã«å«ã¾ã‚Œã‚‹ãŸã‚ã€æ‰‹å‹•ã‚³ãƒ”ãƒ¼ä¸è¦ã§ã™ã€‚<br>
        â€» ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠï¼‰ã‚ˆã‚Šã‚‚ã“ã¡ã‚‰ã®æ–¹æ³•ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
      </p>

      <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
      <div id="previewDropzone" class="preview-dropzone">
        <div class="preview-dropzone-icon">ğŸ“¸</div>
        <div class="preview-dropzone-text">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ9æšã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="preview-dropzone-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
      </div>

      <input type="file" id="previewOnlyInput" accept="image/*" multiple style="display: none;">

      <!-- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ -->
      <div class="selection-counter">
        <span id="previewOnlyCount" class="preview-only-count">0/9 æš</span>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
      <div id="previewOnlyGrid" class="preview-only-grid"></div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="preview-actions" id="previewActions" style="display: none;">
        <button id="clearPreviewBtn" class="clear-preview-btn">ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
        <button id="downloadZipBtn" class="download-zip-btn" disabled>ğŸ“¦ ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>

      <!-- é…ç½®ã‚¬ã‚¤ãƒ‰ -->
      <div class="zip-guide" id="zipGuide" style="display: none;">
        <h4>ğŸ“ ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã®é…ç½®æ‰‹é †</h4>
        <ol>
          <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ <code>{pack-id}-previews.zip</code> ã‚’è§£å‡ï¼ˆ10æš: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼9æš+ã‚µãƒ ãƒã‚¤ãƒ«1æšï¼‰</li>
          <li>è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ï¼ˆ<code>{pack-id}</code>ï¼‰ã‚’ <code>frontend/public/assets/template/</code> ã«ã‚³ãƒ”ãƒ¼</li>
          <li>JSONã‚’ç”Ÿæˆã—ã¦å®Œäº† âœ¨ ã‚µãƒ ãƒã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã¯ä¸è¦ï¼</li>
        </ol>
      </div>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: JSONç”Ÿæˆ -->
    <section class="json-output">
      <h2>3. JSONç”Ÿæˆ</h2>
      <button id="generateBtn" class="primary-btn">ğŸ“„ JSONã‚’ç”Ÿæˆ</button>

      <div id="outputArea" style="display:none;">
        <h3>â‘  templatePacks.json ã«è¿½åŠ ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒª</h3>
        <textarea id="metadataOutput" readonly></textarea>
        <button id="copyMetadataBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>

        <h3>â‘¡ ãƒ‘ãƒƒã‚¯ç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <textarea id="packDataOutput" readonly></textarea>
        <button id="downloadPackBtn">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
    <section class="guide">
      <h2>ğŸ“– ä½¿ã„æ–¹ï¼ˆæ¨å¥¨ãƒ•ãƒ­ãƒ¼ï¼‰</h2>
      <ol>
        <li>ãƒ‘ãƒƒã‚¯æƒ…å ±ã‚’å…¥åŠ›ï¼ˆãƒ‘ãƒƒã‚¯IDã€åå‰ã€èª¬æ˜ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ä¾¡æ ¼ãªã©ï¼‰</li>
        <li>å†™çœŸã‚’è¤‡æ•°é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼‰</li>
        <li>ã‚µãƒ ãƒã‚¤ãƒ«ã«ã—ãŸã„å†™çœŸã‚’1æšã‚¯ãƒªãƒƒã‚¯ï¼ˆé’æ ã§è¡¨ç¤ºï¼‰</li>
        <li><strong>ã€æ¨å¥¨ã€‘</strong> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ9æšã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ï¼‰<br>
            ã¾ãŸã¯ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§9æšé¸æŠï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ï¼‰</li>
        <li>ã€ŒJSONã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ç”Ÿæˆã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>frontend/public/data/templatePacks.json</code> ã® <code>packs</code> é…åˆ—ã«è¿½åŠ </li>
        <li>ãƒ‘ãƒƒã‚¯ç”¨JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ <code>frontend/public/data/packs/</code> ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®</li>
        <li><strong>ã€é‡è¦ã€‘</strong> ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®:
          <ul>
            <li>ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ä½¿ç”¨æ™‚: ã€ŒZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼9æš+ã‚µãƒ ãƒã‚¤ãƒ«1æš=10æšï¼‰ â†’ è§£å‡ â†’ ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ <code>frontend/public/assets/template/</code> ã«ã‚³ãƒ”ãƒ¼</li>
            <li>ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ä½¿ç”¨æ™‚: é¸æŠã—ãŸ9æšã®ç”»åƒã¨ã‚µãƒ ãƒã‚¤ãƒ«ã‚’æ‰‹å‹•ã§ <code>frontend/public/assets/template/{pack-id}/</code> ã«ã‚³ãƒ”ãƒ¼</li>
          </ul>
        </li>
      </ol>

      <h3 style="margin-top: 1.5rem; color: #667eea;">ğŸ“ æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ </h3>
      <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.875rem; line-height: 1.6;">frontend/
â””â”€â”€ public/
    â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ templatePacks.json
    â”‚   â””â”€â”€ packs/
    â”‚       â””â”€â”€ {pack-id}.json
    â””â”€â”€ assets/
        â””â”€â”€ template/
            â””â”€â”€ {pack-id}/              â† ãƒ‘ãƒƒã‚¯IDã”ã¨ã®ãƒ•ã‚©ãƒ«ãƒ€
                â”œâ”€â”€ preview1.jpg        â† ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ9æš
                â”œâ”€â”€ preview2.jpg
                â”œâ”€â”€ ...
                â”œâ”€â”€ preview9.jpg
                â””â”€â”€ thumbnail.jpg       â† ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ</pre>
    </section>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let uploadedPhotos = [];
    let selectedThumbnailIndex = 0;
    let selectedPreviewIndices = []; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒé¸æŠç”¨ï¼ˆ9æšå¿…é ˆï¼‰
    let previewOnlyPhotos = []; // Section 2.6å°‚ç”¨ã®9æšï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('photoInput').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const previewContainer = document.getElementById('photoPreview');
      previewContainer.innerHTML = '<p>å‡¦ç†ä¸­...</p>';
      uploadedPhotos = [];
      selectedPreviewIndices = [];

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        try {
          // Data URLå¤‰æ›
          const dataUrl = await fileToDataUrl(file);

          // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
          const thumbnailUrl = await createThumbnail(dataUrl);

          // å†™çœŸãƒ‡ãƒ¼ã‚¿ä¿å­˜
          const photoData = {
            filename: file.name,
            dataUrl: dataUrl,
            thumbnailUrl: thumbnailUrl,
            width: 0,
            height: 0,
            fileSize: file.size
          };

          uploadedPhotos.push(photoData);
        } catch (error) {
          console.error(`Failed to process ${file.name}:`, error);
        }
      }

      // ç”»åƒã‚µã‚¤ã‚ºå–å¾—
      await Promise.all(uploadedPhotos.map(photo => getImageDimensions(photo)));

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      renderThumbnailPreview();
      renderPreviewSelectionGrid();
    });

    // ã‚µãƒ ãƒã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderThumbnailPreview() {
      const previewContainer = document.getElementById('photoPreview');
      previewContainer.innerHTML = '';

      uploadedPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        if (index === selectedThumbnailIndex) {
          item.classList.add('selected');
          const badge = document.createElement('div');
          badge.className = 'thumbnail-badge';
          badge.textContent = 'ã‚µãƒ ãƒã‚¤ãƒ«';
          item.appendChild(badge);
        }

        const img = document.createElement('img');
        img.src = photo.dataUrl;
        img.alt = photo.filename;
        item.appendChild(img);

        item.addEventListener('click', () => selectThumbnail(index));
        previewContainer.appendChild(item);
      });
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒé¸æŠã‚°ãƒªãƒƒãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPreviewSelectionGrid() {
      const gridContainer = document.getElementById('previewSelectionGrid');

      if (uploadedPhotos.length === 0) {
        gridContainer.innerHTML = '<p style="text-align: center; color: #999;">ã¾ãšå†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>';
        return;
      }

      gridContainer.innerHTML = '';

      uploadedPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        const isSelected = selectedPreviewIndices.includes(index);
        if (isSelected) {
          item.classList.add('preview-selected');
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'preview-checkbox';
        checkbox.checked = isSelected;
        checkbox.addEventListener('change', (e) => togglePreviewSelection(index, e.target.checked));
        item.appendChild(checkbox);

        // ç”»åƒ
        const img = document.createElement('img');
        img.src = photo.dataUrl;
        img.alt = photo.filename;
        item.appendChild(img);

        // ç•ªå·ãƒãƒƒã‚¸
        if (isSelected) {
          const badge = document.createElement('div');
          badge.className = 'preview-badge';
          const position = selectedPreviewIndices.indexOf(index) + 1;
          badge.textContent = `#${position}`;
          item.appendChild(badge);
        }

        gridContainer.appendChild(item);
      });

      updatePreviewCounter();
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«é¸æŠ
    function selectThumbnail(index) {
      selectedThumbnailIndex = index;
      renderThumbnailPreview();
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒé¸æŠã®ãƒˆã‚°ãƒ«
    function togglePreviewSelection(index, isChecked) {
      if (isChecked) {
        if (selectedPreviewIndices.length >= 9) {
          alert('âš ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯æœ€å¤§9æšã¾ã§é¸æŠã§ãã¾ã™ã€‚\nä»–ã®ç”»åƒã‚’é¸æŠã™ã‚‹ã«ã¯ã€æ—¢å­˜ã®é¸æŠã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚');
          renderPreviewSelectionGrid();
          return;
        }
        selectedPreviewIndices.push(index);
      } else {
        const position = selectedPreviewIndices.indexOf(index);
        if (position > -1) {
          selectedPreviewIndices.splice(position, 1);
        }
      }
      renderPreviewSelectionGrid();
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é¸æŠã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
    function updatePreviewCounter() {
      const countElement = document.getElementById('previewCount');
      const count = selectedPreviewIndices.length;

      countElement.textContent = `${count}/9 é¸æŠæ¸ˆã¿`;

      if (count === 9) {
        countElement.classList.add('complete');
      } else {
        countElement.classList.remove('complete');
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é¸æŠã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validatePreviewSelection() {
      const count = selectedPreviewIndices.length;
      const errorElement = document.getElementById('previewError');
      const errorCountElement = document.getElementById('errorCount');

      if (count !== 9) {
        errorElement.hidden = false;
        errorCountElement.textContent = count;
        return false;
      }

      errorElement.hidden = true;
      return true;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Data URLã«å¤‰æ›
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    function createThumbnail(dataUrl, maxSize = 200) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;

          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
          if (width > height) {
            if (width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = dataUrl;
      });
    }

    // ç”»åƒã‚µã‚¤ã‚ºå–å¾—
    function getImageDimensions(photo) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          photo.width = img.width;
          photo.height = img.height;
          resolve();
        };
        img.src = photo.dataUrl;
      });
    }

    // ========================================
    // Section 2.6: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
    // ========================================

    const previewDropzone = document.getElementById('previewDropzone');
    const previewOnlyInput = document.getElementById('previewOnlyInput');

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    previewDropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      previewDropzone.classList.add('drag-over');
    });

    previewDropzone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      previewDropzone.classList.remove('drag-over');
    });

    previewDropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      previewDropzone.classList.remove('drag-over');

      const files = Array.from(e.dataTransfer.files);
      await handlePreviewOnlyFiles(files);
    });

    // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    previewDropzone.addEventListener('click', () => {
      previewOnlyInput.click();
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    previewOnlyInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      await handlePreviewOnlyFiles(files);
      e.target.value = ''; // ãƒªã‚»ãƒƒãƒˆ
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    async function handlePreviewOnlyFiles(files) {
      if (files.length === 0) return;

      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const imageFiles = files.filter(file => file.type.startsWith('image/'));

      if (imageFiles.length !== files.length) {
        alert('âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\n\nç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚');
      }

      if (imageFiles.length === 0) return;

      // 9æšåˆ¶é™ãƒã‚§ãƒƒã‚¯
      const currentCount = previewOnlyPhotos.length;
      const totalCount = currentCount + imageFiles.length;

      if (totalCount > 9) {
        alert(`âš ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯æœ€å¤§9æšã¾ã§ã§ã™ã€‚\n\nç¾åœ¨: ${currentCount}æš\nè¿½åŠ ã—ã‚ˆã†ã¨ã—ãŸ: ${imageFiles.length}æš\nåˆè¨ˆ: ${totalCount}æš\n\n${9 - currentCount}æšã¾ã§è¿½åŠ ã§ãã¾ã™ã€‚\n\nå¯¾å‡¦æ³•:\n- ã€Œã™ã¹ã¦ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã§æ—¢å­˜ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰\n- ã¾ãŸã¯ã€Ã—ãƒœã‚¿ãƒ³ã§ä¸è¦ãªç”»åƒã‚’å€‹åˆ¥ã«å‰Šé™¤`);
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
      for (const file of imageFiles) {
        try {
          const dataUrl = await fileToDataUrl(file);

          const photoData = {
            filename: file.name,
            dataUrl: dataUrl,
            fileSize: file.size
          };

          previewOnlyPhotos.push(photoData);
        } catch (error) {
          console.error(`Failed to process ${file.name}:`, error);
          alert(`âŒ ${file.name} ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
        }
      }

      renderPreviewOnlyGrid();
      updatePreviewOnlyCounter();
      updateDownloadZipButton();
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã‚°ãƒªãƒƒãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPreviewOnlyGrid() {
      const gridContainer = document.getElementById('previewOnlyGrid');
      const actionsContainer = document.getElementById('previewActions');

      if (previewOnlyPhotos.length === 0) {
        gridContainer.innerHTML = '';
        actionsContainer.style.display = 'none';
        return;
      }

      actionsContainer.style.display = 'flex';
      gridContainer.innerHTML = '';

      previewOnlyPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'preview-only-item';

        // ç•ªå·ãƒãƒƒã‚¸
        const badge = document.createElement('div');
        badge.className = 'preview-only-badge';
        badge.textContent = `#${index + 1}`;
        item.appendChild(badge);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-preview-btn';
        removeBtn.textContent = 'Ã—';
        removeBtn.title = 'å‰Šé™¤';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          removePreviewOnly(index);
        };
        item.appendChild(removeBtn);

        // ç”»åƒ
        const img = document.createElement('img');
        img.src = photo.dataUrl;
        img.alt = photo.filename;
        item.appendChild(img);

        gridContainer.appendChild(item);
      });
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ç”»åƒã®å‰Šé™¤
    function removePreviewOnly(index) {
      previewOnlyPhotos.splice(index, 1);
      renderPreviewOnlyGrid();
      updatePreviewOnlyCounter();
      updateDownloadZipButton();
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
    function updatePreviewOnlyCounter() {
      const countElement = document.getElementById('previewOnlyCount');
      const count = previewOnlyPhotos.length;

      countElement.textContent = `${count}/9 æš`;

      if (count === 9) {
        countElement.classList.add('complete');
      } else {
        countElement.classList.remove('complete');
      }
    }

    // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    function updateDownloadZipButton() {
      const downloadBtn = document.getElementById('downloadZipBtn');
      const count = previewOnlyPhotos.length;

      if (count === 9) {
        downloadBtn.disabled = false;
      } else {
        downloadBtn.disabled = true;
      }
    }

    // ã™ã¹ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('clearPreviewBtn').addEventListener('click', () => {
      if (previewOnlyPhotos.length === 0) return;

      if (confirm(`æœ¬å½“ã«ã™ã¹ã¦ã®ç”»åƒï¼ˆ${previewOnlyPhotos.length}æšï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        previewOnlyPhotos = [];
        renderPreviewOnlyGrid();
        updatePreviewOnlyCounter();
        updateDownloadZipButton();
      }
    });

    // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    document.getElementById('downloadZipBtn').addEventListener('click', async () => {
      const packId = document.getElementById('packId').value.trim();

      // Pack IDå¿…é ˆãƒã‚§ãƒƒã‚¯
      if (!packId) {
        alert('âŒ ãƒ‘ãƒƒã‚¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã§ãƒ‘ãƒƒã‚¯IDã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã€ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        document.getElementById('packId').focus();
        return;
      }

      if (previewOnlyPhotos.length !== 9) {
        alert('âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒ9æšã‚ã‚Šã¾ã›ã‚“ã€‚\n\nç¾åœ¨: ' + previewOnlyPhotos.length + 'æš');
        return;
      }

      // ã‚µãƒ ãƒã‚¤ãƒ«é¸æŠãƒã‚§ãƒƒã‚¯
      if (selectedThumbnailIndex === undefined || uploadedPhotos.length === 0) {
        alert('âŒ ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nã‚»ã‚¯ã‚·ãƒ§ãƒ³2ã§å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚µãƒ ãƒã‚¤ãƒ«ã‚’1æšé¸æŠã—ã¦ãã ã•ã„ã€‚');
        document.getElementById('photoPreview').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      try {
        // JSZipã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        const zip = new JSZip();
        const folder = zip.folder(packId);

        // 9æšã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ZIPã«è¿½åŠ 
        for (let i = 0; i < previewOnlyPhotos.length; i++) {
          const photo = previewOnlyPhotos[i];

          // Data URLã‚’Blobã«å¤‰æ›
          const response = await fetch(photo.dataUrl);
          const blob = await response.blob();

          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ«ãƒ€ã«è¿½åŠ 
          folder.file(photo.filename, blob);
        }

        // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚‚ZIPã«è¿½åŠ 
        const thumbnailPhoto = uploadedPhotos[selectedThumbnailIndex];
        const thumbnailResponse = await fetch(thumbnailPhoto.dataUrl);
        const thumbnailBlob = await thumbnailResponse.blob();
        folder.file(thumbnailPhoto.filename, thumbnailBlob);

        // ZIPãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
        const zipBlob = await zip.generateAsync({ type: 'blob' });

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const url = URL.createObjectURL(zipBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${packId}-previews.zip`;
        link.click();
        URL.revokeObjectURL(url);

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
        alert(`âœ… ${packId}-previews.zip ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\n\nğŸ“¦ å«ã¾ã‚Œã‚‹ç”»åƒ: 10æš\n- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ: 9æš\n- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ: 1æš\n\næ¬¡ã®æ‰‹é †:\n1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡\n2. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ï¼ˆ${packId}ï¼‰ã‚’ä»¥ä¸‹ã®å ´æ‰€ã«ã‚³ãƒ”ãƒ¼:\n   frontend/public/assets/template/\n3. JSONã‚’ç”Ÿæˆã—ã¦å®Œäº†`);

        // ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
        document.getElementById('zipGuide').style.display = 'block';
      } catch (error) {
        console.error('ZIP creation failed:', error);
        alert('âŒ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });

    // JSONç”Ÿæˆ
    document.getElementById('generateBtn').addEventListener('click', () => {
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
      const packId = document.getElementById('packId').value.trim();
      const nameJa = document.getElementById('nameJa').value.trim();
      const nameEn = document.getElementById('nameEn').value.trim();
      const descJa = document.getElementById('descJa').value.trim();
      const descEn = document.getElementById('descEn').value.trim();
      const category = document.getElementById('category').value;
      const isFree = document.getElementById('isFree').checked;
      const price = parseInt(document.getElementById('price').value) || 0;
      const stripeProductId = document.getElementById('stripeProductId').value.trim();
      const stripePriceId = document.getElementById('stripePriceId').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!packId || !nameJa || !nameEn || !category || uploadedPhotos.length === 0) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå¿…é ˆé …ç›®:\n- ãƒ‘ãƒƒã‚¯ID\n- ãƒ‘ãƒƒã‚¯åï¼ˆæ—¥è‹±ï¼‰\n- ã‚«ãƒ†ã‚´ãƒªãƒ¼\n- å†™çœŸï¼ˆæœ€ä½1æšï¼‰');
        return;
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå„ªå…ˆé †ä½: Section 2.6 â†’ Section 2.5ï¼‰
      const previewOnlyCount = previewOnlyPhotos.length;
      const previewSelectionCount = selectedPreviewIndices.length;
      let usingPreviewOnly = false;
      let previewImagePaths = [];

      // Section 2.6: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      if (previewOnlyCount === 9) {
        // Section 2.6ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆ
        usingPreviewOnly = true;
        previewImagePaths = previewOnlyPhotos.map(photo =>
          `/assets/template/${packId}/${photo.filename}`
        );
      } else if (previewOnlyCount > 0 && previewOnlyCount < 9) {
        // Section 2.6ãŒéƒ¨åˆ†çš„ã«ã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        alert(`âŒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒä¸å®Œå…¨ã§ã™ã€‚\n\nç¾åœ¨: ${previewOnlyCount}/9 æš\n\nå¯¾å‡¦æ³•:\n- ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¦ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§9æšé¸æŠ\n- ã¾ãŸã¯ã€æ®‹ã‚Š${9 - previewOnlyCount}æšã‚’è¿½åŠ ã—ã¦ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`);
        document.getElementById('previewOnlyGrid').scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
        return;
      } else if (previewSelectionCount === 9) {
        // Section 2.6ãŒç©ºã§ã€Section 2.5ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆ
        usingPreviewOnly = false;
        previewImagePaths = selectedPreviewIndices.map(index =>
          `/assets/template/${packId}/${uploadedPhotos[index].filename}`
        );
      } else {
        // ã©ã¡ã‚‰ã‚‚ä¸å®Œå…¨
        alert(`âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nã€æ¨å¥¨ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ã§ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—:\n- ç¾åœ¨: ${previewOnlyCount}/9 æš\n\nã¾ãŸã¯\n\nã€å¾“æ¥ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.5ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠ:\n- ç¾åœ¨: ${previewSelectionCount}/9 æšé¸æŠæ¸ˆã¿\n\nã©ã¡ã‚‰ã‹ã®æ–¹æ³•ã§æ­£ç¢ºã«9æšé¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
      }

      // ã‚µãƒ ãƒã‚¤ãƒ«URLã‚‚pack-id/filenameå½¢å¼ã«
      const thumbnailPath = `/assets/template/${packId}/${uploadedPhotos[selectedThumbnailIndex].filename}`;

      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONç”Ÿæˆ
      const metadata = {
        id: packId,
        name: {
          ja: nameJa,
          en: nameEn
        },
        description: {
          ja: descJa,
          en: descEn
        },
        category: category,
        price: price,
        photoCount: uploadedPhotos.length,
        thumbnailUrl: thumbnailPath,
        previewImages: previewImagePaths,
        isFree: isFree,
        stripeProductId: stripeProductId,
        stripePriceId: stripePriceId
      };

      // ãƒ‘ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿JSONç”Ÿæˆ
      const packData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        packId: packId,
        packName: nameJa,
        folderName: `ğŸ“¦ ${nameJa}`,
        totalPhotos: uploadedPhotos.length,
        photos: uploadedPhotos.map(photo => ({
          filename: photo.filename,
          dataUrl: photo.dataUrl,
          thumbnailUrl: photo.thumbnailUrl,
          width: photo.width,
          height: photo.height,
          fileSize: photo.fileSize,
          tags: ['template-pack', packId]
        }))
      };

      // å‡ºåŠ›
      document.getElementById('metadataOutput').value = JSON.stringify(metadata, null, 2);
      document.getElementById('packDataOutput').value = JSON.stringify(packData, null, 2);
      document.getElementById('outputArea').style.display = 'block';

      // Section 2.6ä½¿ç”¨æ™‚ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
      if (usingPreviewOnly) {
        alert(`âœ… JSONç”Ÿæˆå®Œäº†ï¼\n\nã€é‡è¦ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å¿˜ã‚Œãšã«:\n\n1. ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.6ã®ã€ŒZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡\n3. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ï¼ˆ${packId}ï¼‰ã‚’ä»¥ä¸‹ã«ã‚³ãƒ”ãƒ¼:\n   frontend/public/assets/template/\n4. ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚‚åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼\n\nãƒ‘ã‚¹ã®ä¾‹:\nfrontend/public/assets/template/${packId}/preview1.jpg`);
      }

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.getElementById('outputArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼
    document.getElementById('copyMetadataBtn').addEventListener('click', () => {
      const textarea = document.getElementById('metadataOutput');
      textarea.select();

      try {
        document.execCommand('copy');
        alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nfrontend/public/data/templatePacks.json ã® packs é…åˆ—ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
      } catch (err) {
        alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    // ãƒ‘ãƒƒã‚¯JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    document.getElementById('downloadPackBtn').addEventListener('click', () => {
      const packId = document.getElementById('packId').value.trim();
      const content = document.getElementById('packDataOutput').value;

      const blob = new Blob([content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${packId}.json`;
      link.click();
      URL.revokeObjectURL(url);

      alert(`âœ… ${packId}.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\n\nfrontend/public/data/packs/ ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚`);
    });

    // ç„¡æ–™ãƒ‘ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‹•ä½œ
    document.getElementById('isFree').addEventListener('change', (e) => {
      const priceInput = document.getElementById('price');
      if (e.target.checked) {
        priceInput.value = '0';
        priceInput.disabled = true;
      } else {
        priceInput.disabled = false;
      }
    });
  </script>
</body>
</html>
