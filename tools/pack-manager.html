<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesdro! ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    /* ãƒªã‚»ãƒƒãƒˆï¼‹åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2rem;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
    }

    h2 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    h3 {
      color: #555;
      margin: 1.5rem 0 0.5rem 0;
      font-size: 1.1rem;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      font-size: 1rem;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    input[type="file"] {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      width: 100%;
    }

    /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
    }

    .preview-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .preview-item.selected {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnail-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #667eea;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 1;
    }

    .info {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }

    /* ãƒœã‚¿ãƒ³ */
    .primary-btn {
      background: #667eea;
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    .primary-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .primary-btn:active {
      transform: translateY(0);
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    button:hover {
      background: #218838;
    }

    button:active {
      transform: scale(0.98);
    }

    /* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
    #outputArea {
      margin-top: 2rem;
    }

    #outputArea textarea {
      font-family: 'Courier New', Consolas, Monaco, monospace;
      font-size: 0.875rem;
      min-height: 200px;
      background: #2d2d2d;
      color: #f8f8f2;
      border: none;
      padding: 1rem;
    }

    /* ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .guide {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
    }

    .guide ol {
      padding-left: 1.5rem;
    }

    .guide li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    .guide code {
      background: #d0d0d0;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }

    /* èª­ã¿è¾¼ã¿ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ Gesdro! ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‘ãƒƒã‚¯æƒ…å ±å…¥åŠ› -->
    <section class="pack-info">
      <h2>1. ãƒ‘ãƒƒã‚¯æƒ…å ±</h2>
      <form id="packForm">
        <input type="text" id="packId" placeholder="ãƒ‘ãƒƒã‚¯IDï¼ˆä¾‹: pack-portrait-proï¼‰" required>

        <input type="text" id="nameJa" placeholder="ãƒ‘ãƒƒã‚¯åï¼ˆæ—¥æœ¬èªï¼‰" required>
        <input type="text" id="nameEn" placeholder="Pack Name (English)" required>

        <textarea id="descJa" placeholder="èª¬æ˜æ–‡ï¼ˆæ—¥æœ¬èªï¼‰" required></textarea>
        <textarea id="descEn" placeholder="Description (English)" required></textarea>

        <select id="category" required>
          <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</option>
          <option value="portrait">ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ</option>
          <option value="pose">ãƒãƒ¼ã‚º</option>
          <option value="hand">æ‰‹</option>
          <option value="animal">å‹•ç‰©</option>
          <option value="landscape">é¢¨æ™¯</option>
        </select>

        <label>
          <input type="checkbox" id="isFree">
          ç„¡æ–™ãƒ‘ãƒƒã‚¯
        </label>

        <input type="number" id="price" placeholder="ä¾¡æ ¼ï¼ˆå††ï¼‰" min="0" value="0">

        <input type="text" id="stripeProductId" placeholder="Stripe Product IDï¼ˆå¾Œã§è¨­å®šå¯ï¼‰">
        <input type="text" id="stripePriceId" placeholder="Stripe Price IDï¼ˆå¾Œã§è¨­å®šå¯ï¼‰">
      </form>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <section class="photo-upload">
      <h2>2. å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <input type="file" id="photoInput" accept="image/*" multiple>
      <div id="photoPreview" class="preview-grid"></div>
      <p class="info">â€» ã‚µãƒ ãƒã‚¤ãƒ«ã«ã—ãŸã„å†™çœŸã‚’1æšã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ï¼ˆé’æ ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: JSONç”Ÿæˆ -->
    <section class="json-output">
      <h2>3. JSONç”Ÿæˆ</h2>
      <button id="generateBtn" class="primary-btn">ğŸ“„ JSONã‚’ç”Ÿæˆ</button>

      <div id="outputArea" style="display:none;">
        <h3>â‘  templatePacks.json ã«è¿½åŠ ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒª</h3>
        <textarea id="metadataOutput" readonly></textarea>
        <button id="copyMetadataBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>

        <h3>â‘¡ ãƒ‘ãƒƒã‚¯ç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <textarea id="packDataOutput" readonly></textarea>
        <button id="downloadPackBtn">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
    <section class="guide">
      <h2>ğŸ“– ä½¿ã„æ–¹</h2>
      <ol>
        <li>ãƒ‘ãƒƒã‚¯æƒ…å ±ã‚’å…¥åŠ›ï¼ˆãƒ‘ãƒƒã‚¯IDã€åå‰ã€èª¬æ˜ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ä¾¡æ ¼ãªã©ï¼‰</li>
        <li>å†™çœŸã‚’è¤‡æ•°é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
        <li>ã‚µãƒ ãƒã‚¤ãƒ«ã«ã—ãŸã„å†™çœŸã‚’1æšã‚¯ãƒªãƒƒã‚¯ï¼ˆé’æ ã§è¡¨ç¤ºï¼‰</li>
        <li>ã€ŒJSONã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ç”Ÿæˆã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>frontend/public/data/templatePacks.json</code> ã® <code>packs</code> é…åˆ—ã«è¿½åŠ </li>
        <li>ãƒ‘ãƒƒã‚¯ç”¨JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ <code>frontend/public/data/packs/</code> ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®</li>
        <li><strong>é‡è¦:</strong> ã‚µãƒ ãƒã‚¤ãƒ«ç”¨ã«é¸æŠã—ãŸå†™çœŸã‚’ <code>frontend/public/assets/template/</code> ã«æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼</li>
      </ol>
    </section>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let uploadedPhotos = [];
    let selectedThumbnailIndex = 0;

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('photoInput').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const previewContainer = document.getElementById('photoPreview');
      previewContainer.innerHTML = '<p>å‡¦ç†ä¸­...</p>';
      uploadedPhotos = [];

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        try {
          // Data URLå¤‰æ›
          const dataUrl = await fileToDataUrl(file);

          // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
          const thumbnailUrl = await createThumbnail(dataUrl);

          // å†™çœŸãƒ‡ãƒ¼ã‚¿ä¿å­˜
          const photoData = {
            filename: file.name,
            dataUrl: dataUrl,
            thumbnailUrl: thumbnailUrl,
            width: 0,
            height: 0,
            fileSize: file.size
          };

          uploadedPhotos.push(photoData);
        } catch (error) {
          console.error(`Failed to process ${file.name}:`, error);
        }
      }

      // ç”»åƒã‚µã‚¤ã‚ºå–å¾—
      await Promise.all(uploadedPhotos.map(photo => getImageDimensions(photo)));

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      renderPhotoPreview();
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPhotoPreview() {
      const previewContainer = document.getElementById('photoPreview');
      previewContainer.innerHTML = '';

      uploadedPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        if (index === selectedThumbnailIndex) {
          item.classList.add('selected');
          const badge = document.createElement('div');
          badge.className = 'thumbnail-badge';
          badge.textContent = 'ã‚µãƒ ãƒã‚¤ãƒ«';
          item.appendChild(badge);
        }

        const img = document.createElement('img');
        img.src = photo.dataUrl;
        img.alt = photo.filename;
        item.appendChild(img);

        item.addEventListener('click', () => selectThumbnail(index));
        previewContainer.appendChild(item);
      });
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«é¸æŠ
    function selectThumbnail(index) {
      selectedThumbnailIndex = index;
      renderPhotoPreview();
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Data URLã«å¤‰æ›
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    function createThumbnail(dataUrl, maxSize = 200) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;

          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
          if (width > height) {
            if (width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = dataUrl;
      });
    }

    // ç”»åƒã‚µã‚¤ã‚ºå–å¾—
    function getImageDimensions(photo) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          photo.width = img.width;
          photo.height = img.height;
          resolve();
        };
        img.src = photo.dataUrl;
      });
    }

    // JSONç”Ÿæˆ
    document.getElementById('generateBtn').addEventListener('click', () => {
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
      const packId = document.getElementById('packId').value.trim();
      const nameJa = document.getElementById('nameJa').value.trim();
      const nameEn = document.getElementById('nameEn').value.trim();
      const descJa = document.getElementById('descJa').value.trim();
      const descEn = document.getElementById('descEn').value.trim();
      const category = document.getElementById('category').value;
      const isFree = document.getElementById('isFree').checked;
      const price = parseInt(document.getElementById('price').value) || 0;
      const stripeProductId = document.getElementById('stripeProductId').value.trim();
      const stripePriceId = document.getElementById('stripePriceId').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!packId || !nameJa || !nameEn || !category || uploadedPhotos.length === 0) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå¿…é ˆé …ç›®:\n- ãƒ‘ãƒƒã‚¯ID\n- ãƒ‘ãƒƒã‚¯åï¼ˆæ—¥è‹±ï¼‰\n- ã‚«ãƒ†ã‚´ãƒªãƒ¼\n- å†™çœŸï¼ˆæœ€ä½1æšï¼‰');
        return;
      }

      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONç”Ÿæˆ
      const metadata = {
        id: packId,
        name: {
          ja: nameJa,
          en: nameEn
        },
        description: {
          ja: descJa,
          en: descEn
        },
        category: category,
        price: price,
        photoCount: uploadedPhotos.length,
        thumbnailUrl: `/assets/template/${uploadedPhotos[selectedThumbnailIndex].filename}`,
        previewImages: [],
        isFree: isFree,
        stripeProductId: stripeProductId,
        stripePriceId: stripePriceId
      };

      // ãƒ‘ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿JSONç”Ÿæˆ
      const packData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        packId: packId,
        packName: nameJa,
        folderName: `ğŸ“¦ ${nameJa}`,
        totalPhotos: uploadedPhotos.length,
        photos: uploadedPhotos.map(photo => ({
          filename: photo.filename,
          dataUrl: photo.dataUrl,
          thumbnailUrl: photo.thumbnailUrl,
          width: photo.width,
          height: photo.height,
          fileSize: photo.fileSize,
          tags: ['template-pack', packId]
        }))
      };

      // å‡ºåŠ›
      document.getElementById('metadataOutput').value = JSON.stringify(metadata, null, 2);
      document.getElementById('packDataOutput').value = JSON.stringify(packData, null, 2);
      document.getElementById('outputArea').style.display = 'block';

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.getElementById('outputArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼
    document.getElementById('copyMetadataBtn').addEventListener('click', () => {
      const textarea = document.getElementById('metadataOutput');
      textarea.select();

      try {
        document.execCommand('copy');
        alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nfrontend/public/data/templatePacks.json ã® packs é…åˆ—ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
      } catch (err) {
        alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    // ãƒ‘ãƒƒã‚¯JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    document.getElementById('downloadPackBtn').addEventListener('click', () => {
      const packId = document.getElementById('packId').value.trim();
      const content = document.getElementById('packDataOutput').value;

      const blob = new Blob([content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${packId}.json`;
      link.click();
      URL.revokeObjectURL(url);

      alert(`âœ… ${packId}.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\n\nfrontend/public/data/packs/ ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚`);
    });

    // ç„¡æ–™ãƒ‘ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‹•ä½œ
    document.getElementById('isFree').addEventListener('change', (e) => {
      const priceInput = document.getElementById('price');
      if (e.target.checked) {
        priceInput.value = '0';
        priceInput.disabled = true;
      } else {
        priceInput.disabled = false;
      }
    });
  </script>
</body>
</html>
